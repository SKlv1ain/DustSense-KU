<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DustSense KU - Air Quality Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap & Chart.js & FontAwesome & Google Fonts -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Prompt&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --bg-color: radial-gradient(ellipse at top left, #111722, #0e0e0e);
      --card-color: #1e1e2f;
      --text-color: #ffffff;
      --icon-bg: #343a50;
      --highlight-box: linear-gradient(145deg, #34334f, #1b1b2e);
    }
    body.light {
      --bg-color: linear-gradient(to bottom, #f9f9f9, #e0e0e0);
      --card-color: #ffffff;
      --text-color: #222222;
      --icon-bg: #f0f0f0;
      --highlight-box: linear-gradient(to bottom, #e6e6e6, #fefefe);
    }
    body {
      font-family: 'Prompt', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.5s, color 0.5s;
    }
    canvas#bgCanvas {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      filter: blur(1px) brightness(0.6);
    }
    .card {
      border: none;
      border-radius: 20px;
      background: var(--card-color);
      color: var(--text-color);
      transition: background 0.5s, color 0.5s;
    }
    h1, h4, h5, p, strong, .section-label {
      color: var(--text-color) !important;
    }
    .aqi-badge {
      font-size: 1.4rem;
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: 600;
    }
    .good { background-color: #198754; color: #fff; }
    .moderate { background-color: #ffc107; color: #000; }
    .unhealthy { background-color: #dc3545; color: #fff; }
    .section-label {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .icon-block {
      font-size: 1.3rem;
      padding: 14px 18px;
      border-radius: 14px;
      background: var(--icon-bg);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 16px;
      font-weight: 500;
      box-shadow: 0 0 6px rgba(255,255,255,0.08);
    }
    .icon-block i {
      font-size: 1.7rem;
    }
    .highlight-box {
      background: var(--highlight-box);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
    }
    .highlight-box p {
      font-size: 1.3rem;
    }

    /* Responsive grid for charts */
    .chart-card {
      position: relative;
      background: var(--card-color);
      border-radius: 20px;
      padding: 1rem;
      height: 250px;
    }
    .chart-card h5 {
      margin-bottom: 0.5rem;
    }
    .chart-container {
      position: absolute;
      top: 2.5rem;
      bottom: 1rem;
      left: 1rem;
      right: 1rem;
    }
    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .skyline {
      background: url('https://i.imgur.com/WwUzB0v.png') no-repeat bottom center;
      background-size: cover;
      opacity: 0.1;
      height: 100px;
    }
    .mode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- Theme Toggle -->
  <div class="mode-toggle">
    <button class="btn btn-sm btn-outline-light" onclick="toggleTheme()">
      <i class="fa-solid fa-circle-half-stroke"></i> Toggle Theme
    </button>
  </div>

  <!-- Dynamic Background -->
  <canvas id="bgCanvas"></canvas>

  <div class="container py-5">
    <h1 class="text-center mb-5">DustSense | Thailand Air Quality Dashboard</h1>
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card p-4 shadow-lg position-relative">
          <span class="position-absolute top-0 end-0 badge bg-danger mt-2 me-3">
            <i class="fa-solid fa-circle-dot"></i> LIVE
          </span>
          <h4>Air Quality Index</h4>
          <h1 class="display-1 fw-bold">{{ latest.pm2_5 }}</h1>
          <div class="aqi-badge {% if latest.pm2_5 > 100 %}unhealthy{% elif latest.pm2_5 > 50 %}moderate{% else %}good{% endif %}">
            {% if latest.pm2_5 > 100 %}Unhealthy{% elif latest.pm2_5 > 50 %}Moderate{% else %}Good{% endif %}
          </div>
          <p class="mt-4"><strong>PM2.5:</strong> {{ latest.pm2_5 }} µg/m³</p>
          <p><strong>PM10:</strong> {{ latest.pm10 }} µg/m³</p>
          <p><strong>Time:</strong> {{ latest.ts }}</p>
          <div class="skyline mt-4"></div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card p-4 shadow-lg">
          <div class="section-label">Environment Info</div>
          <div class="icon-block">
            <i class="fa-solid fa-temperature-half"></i>
            Temperature: <strong>{{ latest.temp }} °C</strong>
          </div>
          <div class="icon-block">
            <i class="fa-solid fa-wind"></i>
            Wind Speed: <strong>9 km/h</strong>
          </div>
          <div class="icon-block">
            <i class="fa-solid fa-droplet"></i>
            Humidity: <strong>{{ latest.humidity }}%</strong>
          </div>
          <div class="icon-block">
            <i class="fa-solid fa-sun"></i>
            UV Index: <strong>0</strong>
          </div>
        </div>
      </div>
    </div>

    <div class="row my-5">
      <div class="col">
        <div class="highlight-box shadow-lg">
          <div class="section-label mb-3">Health Recommendations</div>
          {% if latest.pm2_5 > 100 %}
            <p class="text-danger">❌ Stay indoors. Wear an N95 mask if outside. Keep windows closed.</p>
          {% elif latest.pm2_5 > 50 %}
            <p class="text-warning">⚠️ Moderate risk. Avoid prolonged outdoor exposure. Use a mask.</p>
          {% else %}
            <p class="text-success">✅ Air is safe. Enjoy your outdoor activities.</p>
          {% endif %}
          <img src="https://img.icons8.com/external-flat-juicy-fish/64/ffffff/external-mask-virus-prevention-flat-flat-juicy-fish.png"/>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <div class="col">
        <div class="chart-card">
          <h5>PM2.5 (µg/m³)</h5>
          <div class="chart-container">
            <canvas id="pm25Chart"></canvas>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="chart-card">
          <h5>PM10 (µg/m³)</h5>
          <div class="chart-container">
            <canvas id="pm10Chart"></canvas>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="chart-card">
          <h5>Humidity (%)</h5>
          <div class="chart-container">
            <canvas id="humidityChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="chart-card">
          <h5>Temperature (°C)</h5>
          <div class="chart-container">
            <canvas id="temperatureChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="chart-card">
          <h5>PM2.5 vs PM10</h5>
          <div class="chart-container">
            <canvas id="pmCompareChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      const isLight = document.body.classList.toggle('light');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    }
    window.onload = () => {
      if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light');
      }
    };

    // Background particles
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    for (let i = 0; i < 150; i++) {
      particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 2 + 1, d: Math.random() * 100 });
    }
    let angle = 0;
    function drawParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "rgba(255,255,255,0.08)";
      ctx.shadowColor = "#ffffff";
      ctx.shadowBlur = 1;
      particles.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fill();
      });
      angle += 0.002;
      particles.forEach(p => {
        p.y += Math.cos(angle + p.d) + 0.3;
        p.x += Math.sin(angle) * 0.3;
        if (p.y > canvas.height || p.x > canvas.width || p.x < 0) {
          p.x = Math.random() * canvas.width;
          p.y = -10;
        }
      });
    }
    setInterval(drawParticles, 33);

    // Chart.js data and options
    const labels = {{ timestamps|safe }};
    const pm25   = {{ pm_values|safe }};
    const pm10   = {{ pm10_values|safe }};
    const humidity = {{ humidity_values|safe }};
    const temperature = {{ temperature_values|safe }};

    const chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } }
    };

    new Chart(document.getElementById('pm25Chart'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'PM2.5', data: pm25, tension: 0.3 }] },
      options: chartOptions
    });

    new Chart(document.getElementById('pm10Chart'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'PM10', data: pm10, tension: 0.3 }] },
      options: chartOptions
    });

    new Chart(document.getElementById('humidityChart'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'Humidity', data: humidity, tension: 0.3 }] },
      options: chartOptions
    });

    new Chart(document.getElementById('temperatureChart'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'Temperature', data: temperature, tension: 0.3 }] },
      options: chartOptions
    });

    new Chart(document.getElementById('pmCompareChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'PM2.5', data: pm25, tension: 0.3 },
          { label: 'PM10', data: pm10, tension: 0.3 }
        ]
      },
      options: chartOptions
    });
  </script>
</body>
</html>
